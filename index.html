<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Word Scramble Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #1e40af; /* 진한 파란색 */
      margin: 0; padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1e40af;
    }
    .pill {
      display: inline-block;
      background-color: #bfdbfe; /* 밝은 하늘색 */
      color: #1e40af; /* 진한 파란색 */
      padding: 6px 12px;
      border-radius: 9999px;
      margin: 3px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.25s, color 0.25s;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .pill:hover {
      background-color: #93c5fd;
    }
    .pill.selected {
      background-color: #1e40af;
      color: #bfdbfe;
      box-shadow: 0 0 8px #3b82f6;
    }
    .sentence-block {
      margin-bottom: 1.5rem;
      border: 1px solid #93c5fd;
      border-radius: 0.75rem;
      background: white;
      padding: 1rem 1.25rem;
      width: 100%;
      max-width: 700px;
      box-shadow: 0 2px 10px rgb(59 130 246 / 0.2);
    }
    .sentence-label {
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: #2563eb;
    }
    .word-choices, .user-line {
      min-height: 2.8rem;
      padding: 4px 0;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      background: #f1f5f9;
      margin-bottom: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }
    .user-line {
      background: #dbeafe;
      border-color: #3b82f6;
      min-height: 3rem;
    }
    .word-choices .pill {
      box-shadow: none;
    }
    .user-line .pill {
      box-shadow: 0 0 6px #3b82f6;
    }
    .wrong {
      border-color: #dc2626 !important;
      background-color: #fee2e2 !important;
      color: #b91c1c !important;
      box-shadow: none !important;
    }
    .btn {
      background-color: #1e40af;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s;
      user-select: none;
      margin-right: 0.5rem;
    }
    .btn:hover {
      background-color: #2563eb;
    }
    .btn:disabled {
      background-color: #a5b4fc;
      cursor: not-allowed;
    }
    .nav {
      margin-bottom: 2rem;
    }
    .nav button {
      margin-right: 1rem;
    }
  </style>
</head>
<body>

  <h1>Word Scramble Trainer</h1>

  <div class="nav">
    <button class="btn" id="navHome">홈</button>
    <button class="btn" id="navTest" disabled>테스트</button>
    <button class="btn" id="navReview" disabled>리뷰 (미구현)</button>
    <button class="btn" id="navSettings">설정</button>
  </div>

  <div id="pageHome" class="page">
    <p class="mb-4 max-w-xl text-center">
      .txt 또는 .csv 파일을 업로드하세요.<br>
      빈 줄은 문단 구분, 없으면 10문장 단위로 처리됩니다.<br>
      (현재 테스트는 3문장 단위씩 묶어 진행합니다.)
    </p>
    <input type="file" id="fileInput" accept=".txt,.csv" />
  </div>

  <div id="pageTest" class="page" style="display:none; width: 100%; max-width: 720px;">
    <div id="blocksContainer"></div>

    <div style="margin-top:1rem; display:flex; justify-content:center; align-items:center;">
      <button id="prevBlockBtn" class="btn" disabled>이전</button>
      <button id="checkAnswersBtn" class="btn" style="margin: 0 1rem;">정답 확인</button>
      <button id="nextBlockBtn" class="btn" disabled>다음</button>
    </div>
  </div>

  <div id="pageSettings" class="page" style="display:none; max-width: 720px;">
    <h2 class="text-xl font-bold mb-2">학습 데이터 관리</h2>
    <button class="btn" id="downloadProgressBtn">학습 데이터 다운로드</button>
    <input type="file" id="loadProgressInput" accept="application/json" style="margin-top: 1rem;" />
  </div>

  <script>
    // 상태 변수
    let blocks = []; // SentenceBlock: [[sentence1Words], [sentence2Words], [sentence3Words]]
    let originalSentences = []; // 원본 문장(문장 단위 텍스트)
    let currentBlockIdx = 0;

    // 선택 단어 상태: blocks index -> sentence index -> selected words array
    let selectedWordsState = [];

    // 정답 여부 저장 (blocks index -> sentence index -> boolean)
    let answerCorrectness = [];

    // DOM 참조
    const fileInput = document.getElementById('fileInput');
    const blocksContainer = document.getElementById('blocksContainer');
    const prevBlockBtn = document.getElementById('prevBlockBtn');
    const nextBlockBtn = document.getElementById('nextBlockBtn');
    const checkAnswersBtn = document.getElementById('checkAnswersBtn');

    // 네비게이션 버튼
    const navHome = document.getElementById('navHome');
    const navTest = document.getElementById('navTest');
    const navSettings = document.getElementById('navSettings');

    // 페이지들
    const pageHome = document.getElementById('pageHome');
    const pageTest = document.getElementById('pageTest');
    const pageSettings = document.getElementById('pageSettings');

    // 네비게이션 함수
    function showPage(page) {
      [pageHome, pageTest, pageSettings].forEach(p => p.style.display = 'none');
      if(page === 'home') pageHome.style.display = 'block';
      else if(page === 'test') pageTest.style.display = 'block';
      else if(page === 'settings') pageSettings.style.display = 'block';

      // 버튼 활성/비활성 처리
      navTest.disabled = blocks.length === 0;
      prevBlockBtn.disabled = currentBlockIdx === 0;
      nextBlockBtn.disabled = currentBlockIdx === blocks.length - 1 || blocks.length === 0;
    }

    // 문장 분리 함수 (마침표, 느낌표, 물음표 기준)
    function splitToSentences(text) {
      // 문장 구분 문자 포함해서 분리, 빈 문장 제거
      const raw = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      // .!? 중복 마침표 제거 후 split
      const regex = /([.!?])\s+|\n+/g;
      let sentences = [];
      let start = 0;
      let match;
      while ((match = regex.exec(raw)) !== null) {
        const end = match.index + 1;
        let s = raw.substring(start, end).trim();
        if(s.length > 0) sentences.push(s);
        start = regex.lastIndex;
      }
      // 마지막 문장 처리
      if(start < raw.length) {
        let lastS = raw.substring(start).trim();
        if(lastS.length > 0) sentences.push(lastS);
      }
      return sentences;
    }

    // 문장 3개씩 묶기
    function groupSentences(sentences) {
      const groups = [];
      for(let i=0; i<sentences.length; i+=3) {
        groups.push(sentences.slice(i, i+3));
      }
      return groups;
    }

    // 문장 -> 단어 배열 (공백 기준, 쉼표 등 제거)
    function sentenceToWords(sentence) {
      // 쉼표, 쌍따옴표, 작은따옴표 제거, 앞뒤 공백 제거
      const cleaned = sentence.replace(/[,"'“”‘’]/g, '').trim();
      // 공백 기준 분리
      const words = cleaned.split(/\s+/);
      return words.filter(w => w.length > 0);
    }

    // 배열 무작위 섞기(Fisher-Yates)
    function shuffleArray(arr) {
      let a = arr.slice();
      for(let i = a.length -1; i>0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // 선택 단어 상태 초기화
    function initSelectedWordsState() {
      selectedWordsState = [];
      answerCorrectness = [];
      for(let b=0; b<blocks.length; b++) {
        selectedWordsState[b] = [];
        answerCorrectness[b] = [];
        for(let s=0; s<blocks[b].length; s++) {
          selectedWordsState[b][s] = [];
          answerCorrectness[b][s] = null;
        }
      }
    }

    // 테스트 페이지 렌더링 (현재 블록)
    function renderCurrentBlock() {
      blocksContainer.innerHTML = '';
      if(blocks.length === 0) return;

      const block = blocks[currentBlockIdx];
      const fragment = document.createDocumentFragment();

      block.forEach((sentenceWords, sIdx) => {
        const sentenceDiv = document.createElement('div');
        sentenceDiv.className = 'sentence-block';

        // 문장 라벨
        const label = document.createElement('div');
        label.className = 'sentence-label';
        label.textContent = `문장 ${currentBlockIdx*3 + sIdx + 1}`;
        sentenceDiv.appendChild(label);

        // 선택된 단어 줄 (user-line)
        const userLine = document.createElement('div');
        userLine.className = 'user-line';
        userLine.dataset.sentenceIdx = String(sIdx);
        sentenceDiv.appendChild(userLine);

        // 단어 선택 영역 (shuffled word pills)
        const choices = document.createElement('div');
        choices.className = 'word-choices';
        sentenceDiv.appendChild(choices);

        // 무작위 섞인 단어들
        const shuffled = shuffleArray(sentenceWords);
        shuffled.forEach(word => {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = word;
          pill.dataset.word = word;
          pill.dataset.sentenceIdx = String(sIdx);

          pill.addEventListener('click', () => {
            const s = parseInt(pill.dataset.sentenceIdx);
            const wordText = pill.dataset.word;

            // 현재 선택 단어 배열 참조
            const selected = selectedWordsState[currentBlockIdx][s];
            const idx = selected.indexOf(wordText);

            if(idx === -1) {
              // 선택되지 않은 단어면 선택영역에 추가
              selected.push(wordText);
              pill.classList.add('selected');
              updateUserLine(s);
            } else {
              // 이미 선택된 단어면 해제
              selected.splice(idx, 1);
              pill.classList.remove('selected');
              updateUserLine(s);
            }
          });

          choices.appendChild(pill);
        });

        // 정답 틀렸을 때 스타일링
        if(answerCorrectness[currentBlockIdx][sIdx] === false) {
          userLine.classList.add('wrong');
        } else {
          userLine.classList.remove('wrong');
        }

        fragment.appendChild(sentenceDiv);

        // userLine 업데이트 함수
        function updateUserLine(sentenceIdx) {
          if(sentenceIdx !== sIdx) return;
          const line = userLine;
          line.innerHTML = '';
          selectedWordsState[currentBlockIdx][sentenceIdx].forEach(w => {
            const selPill = document.createElement('span');
            selPill.className = 'pill selected';
            selPill.textContent = w;
            selPill.dataset.word = w;
            selPill.dataset.sentenceIdx = String(sentenceIdx);

            // 클릭하면 선택 해제
            selPill.addEventListener('click', () => {
              const s = parseInt(selPill.dataset.sentenceIdx);
              const wordText = selPill.dataset.word;
              const selected = selectedWordsState[currentBlockIdx][s];
              const idx = selected.indexOf(wordText);
              if(idx !== -1) {
                selected.splice(idx, 1);
                selPill.classList.remove('selected');
                // word pill도 해제 표시
                // 모든 word pills 중에서 같은 단어, 같은 sentenceIdx인 것 찾아서 제거
                [...choices.children].forEach(pill => {
                  if(pill.dataset.word === wordText && pill.dataset.sentenceIdx === String(s)) {
                    pill.classList.remove('selected');
                  }
                });
                updateUserLine(s);
              }
            });
            line.appendChild(selPill);
          });
        }

        // 초기 userLine 렌더링
        updateUserLine(sIdx);
      });

      blocksContainer.appendChild(fragment);

      // 버튼 상태 업데이트
      prevBlockBtn.disabled = currentBlockIdx === 0;
      nextBlockBtn.disabled = currentBlockIdx === blocks.length - 1;
    }

    // 정답 확인 함수
    function checkAnswers() {
      const block = blocks[currentBlockIdx];
      let allCorrect = true;

      block.forEach((sentenceWords, sIdx) => {
        // 정답 단어 배열 (원본 순서)
        const answer = sentenceWords;
        const userSelected = selectedWordsState[currentBlockIdx][sIdx];

        // 길이 및 단어 순서 체크
        const correct = 
          userSelected.length === answer.length &&
          userSelected.every((w, i) => w === answer[i]);

        answerCorrectness[currentBlockIdx][sIdx] = correct;

        if(!correct) allCorrect = false;
      });

      renderCurrentBlock();

      if(allCorrect) {
        alert('모든 문장이 정확히 맞았습니다! 다음 블록으로 이동하세요.');
      } else {
        alert('틀린 문장이 있습니다. 빨간색으로 표시된 문장을 다시 확인하세요.');
      }
    }

    // 파일 업로드 후 처리
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const content = reader.result;
        if(typeof content !== 'string') return;

        // 문장 분리
        const sentences = splitToSentences(content);
        originalSentences = sentences;

        // 3문장씩 묶기
        const grouped = groupSentences(sentences);

        // 각 문장을 단어 배열로 변환
        blocks = grouped.map(sentencesInGroup => {
          return sentencesInGroup.map(sentenceToWords);
        });

        currentBlockIdx = 0;
        initSelectedWordsState();
        answerCorrectness = answerCorrectness.map(
          block => block.map(() => null)
        );

        alert(`총 ${sentences.length}문장, ${blocks.length}개 블록으로 분할 완료`);

        navTest.disabled = false;
        showPage('test');
        renderCurrentBlock();
      };
      reader.readAsText(file);
    });

    prevBlockBtn.addEventListener('click', () => {
      if(currentBlockIdx > 0) {
        currentBlockIdx--;
        renderCurrentBlock();
      }
    });
    nextBlockBtn.addEventListener('click', () => {
      if(currentBlockIdx < blocks.length -1) {
        currentBlockIdx++;
        renderCurrentBlock();
      }
    });
    checkAnswersBtn.addEventListener('click', () => {
      checkAnswers();
    });

    // 네비게이션 버튼
    navHome.addEventListener('click', () => showPage('home'));
    navTest.addEventListener('click', () => {
      if(blocks.length === 0) {
        alert('먼저 파일을 업로드하세요.');
        return;
      }
      showPage('test');
    });
    navSettings.addEventListener('click', () => {
      showPage('settings');
    });

    // 저장 (json 파일로 내보내기)
    document.getElementById('downloadProgressBtn').addEventListener('click', () => {
      if(blocks.length === 0) {
        alert('저장할 학습 데이터가 없습니다.');
        return;
      }
      const data = {
        originalSentences,
        blocks,
        selectedWordsState,
        currentBlockIdx,
        answerCorrectness
      };
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'word_scramble_progress.json';
      a.click();

      URL.revokeObjectURL(url);
    });

    // 불러오기
    document.getElementById('loadProgressInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if(!data.blocks || !data.originalSentences) throw new Error('잘못된 파일입니다.');

          originalSentences = data.originalSentences;
          blocks = data.blocks;
          selectedWordsState = data.selectedWordsState;
          answerCorrectness = data.answerCorrectness;
          currentBlockIdx = data.currentBlockIdx || 0;

          navTest.disabled = false;
          showPage('test');
          renderCurrentBlock();

          alert('학습 데이터를 성공적으로 불러왔습니다.');
        } catch(err) {
          alert('파일을 불러오는 중 오류가 발생했습니다.');
          console.error(err);
        }
      };
      reader.readAsText(file);
      // input 초기화 (같은 파일 다시 업로드 가능)
      e.target.value = '';
    });

    // 초기 화면 세팅
    showPage('home');
  </script>

</body>
</html>
