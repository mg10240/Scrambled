<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Arrangement App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      max-width: 700px;
      text-align: center;
      padding: 2rem;
    }
    .draggable {
      display: inline-block;
      padding: 8px 12px;
      margin: 4px;
      background: #eee;
      color: #000;
      border: 1px solid #aaa;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .draggable:hover {
      background: #ccc;
    }
    #dropZone, #wordBank {
      min-height: 50px;
      margin: 1rem 0;
      padding: 10px;
      border: 2px dashed #aaa;
      border-radius: 8px;
    }
    button {
      padding: 0.5rem 1rem;
      margin: 0.5rem;
      border: none;
      background: #222;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    canvas {
      background: #fff;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Word Arrangement App</h2>
  <input type="file" id="fileInput" accept=".txt" />
  <button onclick="saveProgress()">Save</button>
  <button onclick="loadProgress()">Load</button>
  <button onclick="reviewWrongs()">Review Wrongs</button>
  <p id="container"></p>
  <div id="wordBank"></div>
  <div id="dropZone"></div>
  <button onclick="checkAnswer()">Check</button>
  <canvas id="scoreChart" width="400" height="200"></canvas>
</div>

<script>
let blocks = [];
let blockIndex = 0;
let sentenceIndex = 0;
let corrects = [];
let blockWrongs = [];
let reviewMode = false;

const container = document.getElementById("container");
const wordBank = document.getElementById("wordBank");
const dropZone = document.getElementById("dropZone");
const chartCanvas = document.getElementById("scoreChart");

function cleanText(text) {
  return text.replace(/[.,!?;:"'`~…―·]/g, "").trim();
}

function parseText(text) {
  const sentences = text.split(/(?<=\.|!|\?)\s+/);
  const chunks = [];
  for (let i = 0; i < sentences.length; i += 10) {
    chunks.push(sentences.slice(i, i + 10));
  }
  blocks = chunks;
  corrects = chunks.map(block => Array(block.length).fill(false));
  blockWrongs = chunks.map(() => []);
  blockIndex = 0;
  sentenceIndex = 0;
  reviewMode = false;
  loadSentence();
}

function loadSentence() {
  const block = blocks[blockIndex];
  const idx = reviewMode ? blockWrongs[blockIndex][sentenceIndex] : sentenceIndex;
  const sentence = block[idx];
  const cleanWords = sentence.split(' ').map(cleanText).filter(w => w);
  const shuffled = [...cleanWords].sort(() => Math.random() - 0.5);

  container.textContent = `Block ${blockIndex+1}/${blocks.length}, Sentence ${idx+1}/${block.length}`;
  wordBank.innerHTML = "";
  dropZone.innerHTML = "";

  shuffled.forEach(word => {
    const btn = document.createElement("button");
    btn.className = "draggable";
    btn.textContent = word;
    btn.onclick = () => {
      if ([...dropZone.children].find(e => e.textContent === word)) return;
      const w = document.createElement("button");
      w.textContent = word;
      w.className = "draggable";
      w.onclick = () => dropZone.removeChild(w);
      dropZone.appendChild(w);
    };
    wordBank.appendChild(btn);
  });
}

function checkAnswer() {
  const dropWords = [...dropZone.children].map(e => e.textContent);
  const block = blocks[blockIndex];
  const idx = reviewMode ? blockWrongs[blockIndex][sentenceIndex] : sentenceIndex;
  const sentence = block[idx];
  const correctWords = sentence.split(' ').map(cleanText).filter(w => w);
  const isCorrect = JSON.stringify(dropWords) === JSON.stringify(correctWords);
  corrects[blockIndex][idx] = isCorrect;

  if (!isCorrect && !reviewMode) blockWrongs[blockIndex].push(idx);

  if (sentenceIndex + 1 < (reviewMode ? blockWrongs[blockIndex].length : block.length)) {
    sentenceIndex++;
  } else if (blockIndex + 1 < blocks.length) {
    blockIndex++;
    sentenceIndex = 0;
  } else {
    alert("모든 문장을 완료했습니다.");
    showChart();
    return;
  }
  loadSentence();
}

function saveProgress() {
  localStorage.setItem("progress_blocks", JSON.stringify(blocks));
  localStorage.setItem("progress_corrects", JSON.stringify(corrects));
  localStorage.setItem("progress_wrongs", JSON.stringify(blockWrongs));
  localStorage.setItem("progress_blockIndex", blockIndex);
  localStorage.setItem("progress_sentenceIndex", sentenceIndex);
  alert("저장 완료");
}

function loadProgress() {
  const b = localStorage.getItem("progress_blocks");
  if (!b) return alert("저장된 데이터가 없습니다.");
  blocks = JSON.parse(b);
  corrects = JSON.parse(localStorage.getItem("progress_corrects"));
  blockWrongs = JSON.parse(localStorage.getItem("progress_wrongs"));
  blockIndex = +localStorage.getItem("progress_blockIndex");
  sentenceIndex = +localStorage.getItem("progress_sentenceIndex");
  reviewMode = false;
  loadSentence();
}

function reviewWrongs() {
  reviewMode = true;
  sentenceIndex = 0;
  loadSentence();
}

function showChart() {
  const scores = corrects.map(arr => arr.filter(Boolean).length / arr.length * 100);
  new Chart(chartCanvas, {
    type: 'bar',
    data: {
      labels: scores.map((_, i) => `Block ${i + 1}`),
      datasets: [{
        label: 'Accuracy (%)',
        data: scores,
        borderColor: '#000',
        backgroundColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#000'
          }
        },
        x: {
          ticks: {
            color: '#000'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#000'
          }
        }
      }
    }
  });
}

document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => parseText(evt.target.result);
  reader.readAsText(file);
});
</script>
</body>
</html>
