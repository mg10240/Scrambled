<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Word Scramble Review</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fff;
      color: #111;
    }

    .btn {
      @apply px-4 py-2 border-2 rounded-lg font-semibold transition-colors duration-200;
      border-color: #000;
      background-color: #fff;
      color: #000;
    }

    .btn:hover {
      background-color: #000;
      color: #fff;
    }

    .word-option {
      @apply px-3 py-1 m-1 bg-black text-white rounded cursor-pointer transition;
    }

    .word-option:hover {
      background-color: #333;
    }

    .word-line {
      @apply flex flex-wrap gap-2 min-h-[3rem] p-3 border border-black rounded mb-4;
    }

    .wrong {
      background-color: #f00 !important;
      color: #fff !important;
    }

    canvas {
      background: #fff;
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-3xl mx-auto shadow-lg border border-black rounded-2xl p-8 space-y-6">
    <nav class="flex justify-center gap-4 mb-6">
      <button onclick="showPage('home')" class="btn">홈</button>
      <button onclick="showPage('test')" class="btn">테스트</button>
      <button onclick="showPage('result')" class="btn">리뷰</button>
      <button onclick="showPage('settings')" class="btn">설정</button>
    </nav>

    <!-- Home -->
    <div id="home" class="page">
      <h1 class="text-2xl font-bold mb-2">Word Scramble</h1>
      <p>.txt 또는 .csv 파일 업로드 (빈 줄 → 문단 구분, 없으면 10문장씩)</p>
      <input type="file" id="fileInput" accept=".txt,.csv" class="mt-4"/>
    </div>

    <!-- Test -->
    <div id="test" class="page hidden">
      <h2 class="text-xl font-bold mb-2">문장 배열</h2>
      <div id="sentenceLabel" class="mb-2"></div>
      <div id="userLine" class="word-line"></div>
      <div id="wordChoices" class="flex flex-wrap gap-2 mb-4"></div>
      <button id="checkButton" class="btn">정답 확인</button>
    </div>

    <!-- Result -->
    <div id="result" class="page hidden">
      <h2 class="text-xl font-bold mb-2">재시도 분석</h2>
      <canvas id="errorChart" class="w-full max-h-96"></canvas>
    </div>

    <!-- Settings -->
    <div id="settings" class="page hidden">
      <h2 class="text-xl font-bold mb-2">설정</h2>
      <button onclick="resetData()" class="btn">저장 데이터 초기화</button>
    </div>
  </div>

  <script>
    let blocks = [], retryCounts = [], blockIndex = 0;
    let reviewMode = false, reviewIndices = [], reviewPointer = 0;
    let fileHash = '', chart;
    const fileInput = document.getElementById('fileInput');
    const wordChoices = document.getElementById('wordChoices');
    const userLine = document.getElementById('userLine');
    const checkBtn = document.getElementById('checkButton');
    const label = document.getElementById('sentenceLabel');
    const chartCanvas = document.getElementById('errorChart');

    fileInput.onchange = async e => {
      const text = await e.target.files[0].text();
      fileHash = await hashString(text);
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      let paras = [];
      let cur = [];

      for (let l of lines) {
        if (l === '') {
          if (cur.length) { paras.push(cur); cur = []; }
        } else cur.push(l);
      }
      if (cur.length) paras.push(cur);

      if (!paras.length) {
        for (let i = 0; i < lines.length; i += 10)
          paras.push(lines.slice(i, i + 10));
      }

      blocks = paras.map(group => group.map(sent =>
        sent.replace(/[.,!?;:"“”‘’']/g, '').trim()
      ));
      retryCounts = blocks.map(b => b.map(() => 0));
      blockIndex = 0;
      reviewMode = false;
      reviewIndices = [];
      reviewPointer = 0;
      saveProgress();
      loadSentence();
      showPage('test');
    };

    function loadSentence() {
      userLine.innerHTML = '';
      wordChoices.innerHTML = '';
      const block = blocks[blockIndex];

      let idx;
      if (reviewMode) {
        if (reviewPointer >= reviewIndices.length) {
          nextBlock(); return;
        }
        idx = reviewIndices[reviewPointer];
      } else {
        idx = block.findIndex((_, i) => retryCounts[blockIndex][i] === 0);
        if (idx === -1) {
          // 복습 모드로 전환
          reviewIndices = retryCounts[blockIndex]
            .map((v, i) => v > 0 ? i : -1).filter(i => i !== -1);
          if (reviewIndices.length === 0) { nextBlock(); return; }
          reviewMode = true;
          reviewPointer = 0;
          loadSentence();
          return;
        }
      }

      const sentence = block[idx];
      label.textContent = `Block ${blockIndex + 1} - Sentence ${idx + 1}`;
      const words = sentence.split(' ').sort(() => Math.random() - 0.5);
      words.forEach(w => {
        const btn = document.createElement('button');
        btn.className = 'word-option';
        btn.textContent = w;
        btn.onclick = () => {
          const chosen = document.createElement('button');
          chosen.textContent = w;
          chosen.className = 'word-option';
          chosen.onclick = () => chosen.remove();
          userLine.appendChild(chosen);
          btn.remove();
        };
        wordChoices.appendChild(btn);
      });
    }

    checkBtn.onclick = () => {
      const block = blocks[blockIndex];
      let idx = reviewMode ? reviewIndices[reviewPointer] : block.findIndex((_, i) => retryCounts[blockIndex][i] === 0);
      const correct = block[idx].split(' ');
      const user = Array.from(userLine.children).map(e => e.textContent);

      let wrong = false;
      userLine.childNodes.forEach((el, i) => {
        if (el.textContent !== correct[i]) {
          el.classList.add('wrong'); wrong = true;
        } else el.classList.remove('wrong');
      });

      if (wrong) retryCounts[blockIndex][idx]++;
      else reviewMode ? reviewPointer++ : retryCounts[blockIndex][idx] = -1;

      saveProgress(); updateChart();
      setTimeout(loadSentence, 600);
    };

    function nextBlock() {
      blockIndex++;
      reviewMode = false;
      reviewPointer = 0;
      if (blockIndex >= blocks.length) {
        label.textContent = "🎉 모든 학습 완료!";
        userLine.innerHTML = '';
        wordChoices.innerHTML = '';
      } else {
        loadSentence();
      }
    }

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'result') updateChart();
    }

    function updateChart() {
      const data = retryCounts.flat().filter(v => v >= 0);
      const labels = data.map((_, i) => `${i + 1}`);
      chart?.destroy();
      chart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '오답 횟수',
            data,
            backgroundColor: '#000',
            borderColor: '#444',
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#000' } }
          },
          scales: {
            x: { ticks: { color: '#000' } },
            y: {
              beginAtZero: true,
              ticks: { color: '#000' }
            }
          }
        }
      });
    }

    function resetData() {
      localStorage.removeItem('scramble_' + fileHash);
      location.reload();
    }

    function saveProgress() {
      if (!fileHash) return;
      localStorage.setItem('scramble_' + fileHash, JSON.stringify({
        blocks, retryCounts, blockIndex, reviewMode, reviewIndices, reviewPointer
      }));
    }

    function loadSavedProgress() {
      const saved = localStorage.getItem('scramble_' + fileHash);
      if (saved) {
        const data = JSON.parse(saved);
        Object.assign(window, data);
        showPage('test');
        loadSentence();
      }
    }

    async function hashString(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>
