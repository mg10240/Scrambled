<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Word Scramble Trainer</title>

  <!-- Tailwind + Radix colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@radix-ui/colors@latest/blackA.css" rel="stylesheet">

  <style>
    /* 기본 폰트와 배경 */
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      color: #111827;
      min-height: 100vh;
    }
    /* 홈 탭 파란 테두리 - 처음에만 */
    #home.first-visit {
      border: 3px solid #2563eb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 12px rgb(37 99 235 / 0.5);
      transition: border-color 0.3s ease;
    }
    /* input box 기본 스타일 */
    input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 1rem;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 6px #2563ebaa;
    }
    input.wrong {
      border-color: #dc2626 !important;
      box-shadow: 0 0 8px #dc2626aa !important;
      background-color: #fee2e2;
    }
    /* 버튼 공통 스타일 */
    .btn {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(37 99 235 / 0.4);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      user-select: none;
      border: none;
    }
    .btn:hover {
      background-color: #1d4ed8;
      box-shadow: 0 4px 14px rgb(29 78 216 / 0.7);
    }
    .btn:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
      box-shadow: none;
    }

    nav button {
      margin: 0 0.25rem;
    }

    /* 페이징 버튼 그룹 */
    #pagingControls {
      display: flex;
      justify-content: space-between;
      margin: 1rem 0;
    }

    /* 애니메이션 */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 파일 업로드 input */
    input[type="file"] {
      cursor: pointer;
      border: 1.5px solid #2563eb;
      border-radius: 8px;
      padding: 0.4rem 0.6rem;
      background: #e0e7ff;
      color: #1e3a8a;
      font-weight: 600;
    }
    input[type="file"]:hover {
      background: #c7d2fe;
    }

    /* 네비게이션 바 스타일 */
    nav {
      background: white;
      padding: 0.6rem 1rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      border-radius: 12px;
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
      user-select: none;
    }
    nav button {
      background: transparent;
      color: #2563eb;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 0.25rem 1rem;
      border-radius: 8px;
      border: none;
      transition: background-color 0.3s ease;
    }
    nav button:hover {
      background: #e0e7ff;
      cursor: pointer;
    }
    nav button.active {
      background: #2563eb;
      color: white;
      cursor: default;
      box-shadow: 0 2px 10px rgb(37 99 235 / 0.6);
    }

    /* 문장 입력창 리스트 */
    #sentencesContainer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
  </style>
</head>
<body>

  <div class="max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-lg mt-6">
    <nav>
      <button id="navHome" class="active" type="button">홈</button>
      <button id="navTest" type="button">테스트</button>
      <button id="navResult" type="button">리뷰</button>
      <button id="navSettings" type="button">설정</button>
    </nav>

    <!-- Home -->
    <section id="home" class="fade-in first-visit">
      <h1 class="text-3xl font-bold mb-4">Word Scramble</h1>
      <p class="mb-6 text-gray-700">
        .txt 또는 .csv 파일을 업로드하세요.<br />
        빈 줄은 문단 구분으로 인식하며,<br />
        없으면 10문장 단위로 처리됩니다.
      </p>
      <input type="file" id="fileInput" accept=".txt,.csv" />
    </section>

    <!-- Test -->
    <section id="test" class="hidden fade-in">
      <h2 class="text-2xl font-semibold mb-4">문장 배열 맞추기</h2>
      <div id="blockInfo" class="mb-3 font-semibold text-gray-800"></div>

      <div id="sentencesContainer"></div>

      <div id="pagingControls" class="mb-6">
        <button id="prevPage" class="btn" disabled>이전</button>
        <button id="nextPage" class="btn" disabled>다음</button>
      </div>

      <button id="checkAnswers" class="btn w-full">정답 확인</button>
    </section>

    <!-- Result -->
    <section id="result" class="hidden fade-in">
      <h2 class="text-2xl font-semibold mb-4">오답 분석 그래프</h2>
      <canvas id="errorChart" class="w-full max-h-96"></canvas>
    </section>

    <!-- Settings -->
    <section id="settings" class="hidden fade-in">
      <h2 class="text-2xl font-semibold mb-6">설정</h2>
      <button id="downloadProgress" class="btn mb-4 w-full">학습 데이터 다운로드</button>
      <input type="file" id="loadProgress" accept="application/json" />
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    (() => {
      'use strict';

      // --- 상태 변수 ---
      let rawText = '';
      let blocks = [];      // 문단 단위 분리된 배열
      let allSentences = []; // 모든 문장 flat 배열 (문단, 문장구분없이)
      let currentBlockIndex = 0;
      let currentPageIndex = 0; // 3문장씩 페이징 처리
      const SENTENCES_PER_PAGE = 3;
      let userInputs = [];  // [[string, ...], ...] 각 문장에 대한 유저 입력 (2차원)

      // --- DOM 참조 ---
      const homeSection = document.getElementById('home');
      const testSection = document.getElementById('test');
      const resultSection = document.getElementById('result');
      const settingsSection = document.getElementById('settings');

      const navHome = document.getElementById('navHome');
      const navTest = document.getElementById('navTest');
      const navResult = document.getElementById('navResult');
      const navSettings = document.getElementById('navSettings');

      const fileInput = document.getElementById('fileInput');
      const sentencesContainer = document.getElementById('sentencesContainer');
      const blockInfo = document.getElementById('blockInfo');

      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const checkAnswersBtn = document.getElementById('checkAnswers');

      const downloadProgressBtn = document.getElementById('downloadProgress');
      const loadProgressInput = document.getElementById('loadProgress');

      // --- 네비게이션 함수 ---
      function setActiveTab(tabName) {
        // 모든 섹션 숨기기
        [homeSection, testSection, resultSection, settingsSection].forEach(sec => sec.classList.add('hidden'));
        // 모든 nav 버튼 비활성화
        [navHome, navTest, navResult, navSettings].forEach(btn => btn.classList.remove('active'));

        switch(tabName) {
          case 'home':
            homeSection.classList.remove('hidden');
            navHome.classList.add('active');
            break;
          case 'test':
            testSection.classList.remove('hidden');
            navTest.classList.add('active');
            break;
          case 'result':
            resultSection.classList.remove('hidden');
            navResult.classList.add('active');
            break;
          case 'settings':
            settingsSection.classList.remove('hidden');
            navSettings.classList.add('active');
            break;
        }
        // 홈 탭 파란 테두리 최초 방문시에만 표시하고, 다른 탭 갔다 오면 제거
        if (tabName !== 'home' && homeSection.classList.contains('first-visit')) {
          homeSection.classList.remove('first-visit');
        }
      }

      navHome.onclick = () => setActiveTab('home');
      navTest.onclick = () => setActiveTab('test');
      navResult.onclick = () => setActiveTab('result');
      navSettings.onclick = () => setActiveTab('settings');

      // --- 문단/문장 분리 함수 ---
      function splitTextToBlocks(text) {
        // 빈 줄(\n\n 이상)을 기준으로 문단 분리
        let paragraphs = text.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
        if (paragraphs.length === 0) return [];

        // 각 문단 별 문장 단위 분리(마침표, 느낌표, 물음표 등)
        const sentenceRegex = /.*?[.!?]+(?=\s|$)|.+$/g;

        // 각 문단에서 문장별 배열 생성
        const blocks = paragraphs.map(paragraph => {
          const sentences = paragraph.match(sentenceRegex) || [paragraph];
          return sentences.map(s => s.trim()).filter(s => s.length > 0);
        });

        // 빈 줄이 없으면(문단이 하나뿐이면) 10문장 단위로 나누기
        if (paragraphs.length === 1) {
          const allSents = blocks[0];
          const chunked = [];
          for (let i = 0; i < allSents.length; i += 10) {
            chunked.push(allSents.slice(i, i + 10));
          }
          return chunked;
        }

        return blocks;
      }

      // --- 페이지 내 3문장 단위 페이징 함수 ---
      function getPageSentences(block, pageIndex) {
        const start = pageIndex * SENTENCES_PER_PAGE;
        return block.slice(start, start + SENTENCES_PER_PAGE);
      }

      // --- 테스트 문장 표시 함수 ---
      function renderTestPage() {
        if (!blocks.length) {
          sentencesContainer.innerHTML = '<p class="text-gray-500">파일을 먼저 업로드하세요.</p>';
          checkAnswersBtn.disabled = true;
          prevPageBtn.disabled = true;
          nextPageBtn.disabled = true;
          blockInfo.textContent = '';
          return;
        }

        const block = blocks[currentBlockIndex];
        const totalPages = Math.ceil(block.length / SENTENCES_PER_PAGE);

        blockInfo.textContent = `문단 ${currentBlockIndex + 1} / ${blocks.length} — 페이지 ${currentPageIndex + 1} / ${totalPages}`;
        checkAnswersBtn.disabled = false;

        // 페이징 버튼 활성화/비활성화
        prevPageBtn.disabled = currentPageIndex === 0;
        nextPageBtn.disabled = currentPageIndex >= totalPages - 1;

        // 현재 페이지 문장들
        const pageSents = getPageSentences(block, currentPageIndex);

        // 입력창 렌더링
        sentencesContainer.innerHTML = '';
        pageSents.forEach((sentence, idx) => {
          const div = document.createElement('div');
          div.className = 'fade-in';

          const input = document.createElement('input');
          input.type = 'text';
          input.value = userInputs[currentBlockIndex]?.[currentPageIndex * SENTENCES_PER_PAGE + idx] || '';
          input.placeholder = `문장 ${currentPageIndex * SENTENCES_PER_PAGE + idx + 1} 입력`;
          input.autocomplete = 'off';

          input.oninput = () => {
            if (!userInputs[currentBlockIndex]) userInputs[currentBlockIndex] = [];
            userInputs[currentBlockIndex][currentPageIndex * SENTENCES_PER_PAGE + idx] = input.value;
            input.classList.remove('wrong');
          };

          div.appendChild(input);
          sentencesContainer.appendChild(div);
        });
      }

      // --- 정답 확인 ---
      function checkAnswers() {
        const block = blocks[currentBlockIndex];
        const totalPages = Math.ceil(block.length / SENTENCES_PER_PAGE);
        const pageSents = getPageSentences(block, currentPageIndex);

        let allCorrect = true;
        const inputs = sentencesContainer.querySelectorAll('input[type="text"]');

        inputs.forEach((input, idx) => {
          const correct = pageSents[idx].trim();
          const userAnswer = input.value.trim();
          if (userAnswer !== correct) {
            input.classList.add('wrong');
            allCorrect = false;
          } else {
            input.classList.remove('wrong');
          }
        });

        if (allCorrect) {
          alert('모든 문장이 정확합니다!');
          // 자동 다음 페이지 이동 (있으면)
          if (currentPageIndex < totalPages - 1) {
            currentPageIndex++;
            renderTestPage();
          }
          // 마지막 페이지면 자동으로 다음 문단으로
          else if (currentBlockIndex < blocks.length - 1) {
            currentBlockIndex++;
            currentPageIndex = 0;
            renderTestPage();
          }
        }
      }

      // --- 파일 읽기 ---
      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = evt => {
          rawText = evt.target.result;
          blocks = splitTextToBlocks(rawText);
          userInputs = blocks.map(block => Array(block.length).fill(''));
          currentBlockIndex = 0;
          currentPageIndex = 0;
          setActiveTab('test');
          renderTestPage();
        };
        reader.readAsText(file, 'UTF-8');
      });

      // --- 페이징 버튼 이벤트 ---
      prevPageBtn.onclick = () => {
        if (currentPageIndex > 0) {
          currentPageIndex--;
          renderTestPage();
        }
      };
      nextPageBtn.onclick = () => {
        const block = blocks[currentBlockIndex];
        const totalPages = Math.ceil(block.length / SENTENCES_PER_PAGE);
        if (currentPageIndex < totalPages - 1) {
          currentPageIndex++;
          renderTestPage();
        }
      };

      checkAnswersBtn.onclick = checkAnswers;

      // --- 데이터 다운로드 ---
      downloadProgressBtn.onclick = () => {
        const data = {
          rawText,
          userInputs,
          currentBlockIndex,
          currentPageIndex
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'word_scramble_save.json';
        a.click();
        URL.revokeObjectURL(a.href);
      };

      // --- 데이터 불러오기 ---
      loadProgressInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            const data = JSON.parse(evt.target.result);
            rawText = data.rawText || '';
            blocks = splitTextToBlocks(rawText);
            userInputs = data.userInputs || blocks.map(block => Array(block.length).fill(''));
            currentBlockIndex = data.currentBlockIndex || 0;
            currentPageIndex = data.currentPageIndex || 0;

            if (!blocks.length) {
              alert('불러온 데이터가 올바르지 않습니다.');
              return;
            }
            setActiveTab('test');
            renderTestPage();
          } catch (err) {
            alert('JSON 파일 형식이 올바르지 않습니다.');
          }
        };
        reader.readAsText(file, 'UTF-8');
      });

      // --- 페이지 초기 세팅 ---
      setActiveTab('home');

      // --- 포커스 outline 문제 방지 ---
      window.onload = () => {
        if (document.activeElement) document.activeElement.blur();
      };
    })();
  </script>

</body>
</html>
